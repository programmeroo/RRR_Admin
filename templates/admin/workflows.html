{% extends "admin/base.html" %}

{% block title %}Workflows{% endblock %}
{% block page_title %}Workflow Management{% endblock %}

{% block content %}

<!-- Workflow Status Panel -->
<div class="glass-panel mb-4 {% if workflow_status.running %}border-warning{% endif %}">
  <div class="p-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h5 class="mb-0 d-flex align-items-center gap-2">
        <i class="bi bi-activity text-info"></i> Workflow Status
      </h5>
      {% if workflow_status.running %}
      <span class="badge bg-warning text-dark animate-pulse">RUNNING</span>
      {% else %}
      <span class="badge bg-secondary">IDLE</span>
      {% endif %}
    </div>

    {% if workflow_status.running %}
    <div class="mb-4">
      <div class="d-flex justify-content-between mb-2">
        <span class="text-white fw-bold">{{ workflow_status.current_task }}</span>
        <span class="text-muted small">Started: {{ workflow_status.started_at }}</span>
      </div>
      <div class="progress bg-secondary bg-opacity-25" style="height: 10px;">
        <div class="progress-bar progress-bar-striped progress-bar-animated bg-warning" role="progressbar"
          style="width: 100%"></div>
      </div>
    </div>
    {% else %}
    {% if workflow_status.completed_at %}
    <div
      class="alert alert-success bg-opacity-10 border-success border-opacity-25 text-success d-flex align-items-center gap-2 mb-4">
      <i class="bi bi-check-circle-fill"></i>
      <span>Last workflow completed at {{ workflow_status.completed_at }}</span>
    </div>
    {% endif %}
    {% endif %}

    <!-- Console Output -->
    <div class="bg-dark rounded p-3 font-monospace small border border-secondary border-opacity-25"
      style="max-height: 250px; overflow-y: auto;">
      {% if workflow_status.progress %}
      {% for entry in workflow_status.progress[-10:] %}
      <div class="mb-1">
        <span class="text-muted">[{{ entry.timestamp }}]</span>
        <span class="text-info">{{ entry.task }}:</span>
        <span class="text-white-50">{{ entry.message }}</span>
      </div>
      {% endfor %}
      {% else %}
      <div class="text-muted fst-italic">Waiting for workflow logs...</div>
      {% endif %}

      {% if workflow_status.errors %}
      <div class="mt-3 pt-3 border-top border-secondary border-opacity-25">
        {% for error in workflow_status.errors %}
        <div class="text-danger">
          <span class="fw-bold">ERROR:</span> [{{ error.timestamp }}] {{ error.task }}: {{ error.message }}
        </div>
        {% endfor %}
      </div>
      {% endif %}
    </div>

    <div class="mt-3 text-end">
      <button class="btn btn-sm btn-outline-secondary" onclick="window.location.reload()">
        <i class="bi bi-arrow-clockwise"></i> Refresh Logs
      </button>
    </div>
  </div>
</div>

<!-- Current Stats Cards -->
<div class="row g-4 mb-4">
  <div class="col-md-4">
    <div class="glass-card p-3 text-center">
      <h3 class="fw-bold text-white mb-1">{{ stats.new_listings }}</h3>
      <p class="text-muted small mb-0">New Listings</p>
    </div>
  </div>
  <div class="col-md-4">
    <div class="glass-card p-3 text-center">
      <h3 class="fw-bold text-success mb-1">{{ stats.listings_quoted }}</h3>
      <p class="text-muted small mb-0">Ready for Email</p>
    </div>
  </div>
  <div class="col-md-4">
    <div class="glass-card p-3 text-center">
      <h3 class="fw-bold text-info mb-1">{{ stats.listings_dscr_quoted }}</h3>
      <p class="text-muted small mb-0">DSCR Quoted</p>
    </div>
  </div>
</div>

<div class="row g-4 mb-4">
  <!-- Main Workflow -->
  <div class="col-lg-6">
    <div class="glass-panel p-4 h-100">
      <h5 class="mb-4 d-flex align-items-center gap-2">
        <i class="bi bi-diagram-3-fill text-primary"></i> Main Workflow
      </h5>

      <form method="POST" action="{{ url_for('workflow.run_workflow', workflow_name='main') }}" class="h-100 d-flex flex-column">
        <div class="glass-card p-4 flex-grow-1 d-flex flex-column">
          <div class="d-flex align-items-center gap-3 mb-3">
            <div class="rounded bg-primary bg-opacity-20 p-3 text-primary">
              <i class="bi bi-gear-fill fs-3"></i>
            </div>
            <div>
              <h6 class="mb-1 text-white">Data Pipeline</h6>
              <p class="mb-0 text-muted small">Insert & Process Listings</p>
            </div>
          </div>

          <div class="flex-grow-1 mb-3">
            <p class="text-muted small mb-3">Scrape → Process → Archive → Cleanup</p>

            <div class="bg-dark bg-opacity-25 rounded p-3 mb-3">
              <div class="d-flex align-items-center gap-2 mb-2">
                <i class="bi bi-1-circle text-primary"></i>
                <span class="text-white small">Scrape HTML files from Downloads</span>
              </div>
              <div class="d-flex align-items-center gap-2 mb-2">
                <i class="bi bi-2-circle text-primary"></i>
                <span class="text-white small">Process listings into database</span>
              </div>
              <div class="d-flex align-items-center gap-2 mb-2">
                <i class="bi bi-3-circle text-primary"></i>
                <span class="text-white small">Archive old listings</span>
              </div>
              <div class="d-flex align-items-center gap-2">
                <i class="bi bi-4-circle text-primary"></i>
                <span class="text-white small">Cleanup archived data</span>
              </div>
            </div>
          </div>

          <button type="submit" class="btn btn-primary w-100 btn-lg" {% if workflow_status.running %}disabled{% endif %}>
            <i class="bi bi-play-fill"></i> Run Main Workflow
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Weekly Reports Workflow -->
  <div class="col-lg-6">
    <div class="glass-panel p-4 h-100">
      <h5 class="mb-4 d-flex align-items-center gap-2">
        <i class="bi bi-calendar-week-fill text-success"></i> Weekly Reports
      </h5>

      <form method="POST" action="{{ url_for('workflow.run_reports') }}" class="h-100 d-flex flex-column">
        <div class="glass-card p-4 flex-grow-1 d-flex flex-column">
          <div class="d-flex align-items-center gap-3 mb-3">
            <div class="rounded bg-success bg-opacity-20 p-3 text-success">
              <i class="bi bi-envelope-paper-fill fs-3"></i>
            </div>
            <div>
              <h6 class="mb-1 text-white">4-Week Email Campaign</h6>
              <p class="mb-0 text-muted small">Automated weekly touchpoints</p>
            </div>
          </div>

          <div class="flex-grow-1 mb-3">
            <div class="bg-dark bg-opacity-25 rounded p-3 mb-3">
              <div class="d-flex align-items-center gap-2 mb-2">
                <i class="bi bi-1-circle text-success"></i>
                <span class="text-white small"><strong>Week 1:</strong> QM Quotes (Conv/FHA/VA)</span>
              </div>
              <div class="d-flex align-items-center gap-2 mb-2">
                <i class="bi bi-2-circle text-success"></i>
                <span class="text-white small"><strong>Week 2:</strong> Affordability Reports</span>
              </div>
              <div class="d-flex align-items-center gap-2 mb-2">
                <i class="bi bi-3-circle text-success"></i>
                <span class="text-white small"><strong>Week 3:</strong> DSCR Quotes (Investor)</span>
              </div>
              <div class="d-flex align-items-center gap-2">
                <i class="bi bi-4-circle text-success"></i>
                <span class="text-white small"><strong>Week 4:</strong> Follow-up Emails</span>
              </div>
            </div>

            <select name="week" class="form-select form-select-sm mb-2">
              <option value="">All Weeks (Default)</option>
              <option value="1">Week 1: QM Quotes</option>
              <option value="2">Week 2: Affordability</option>
              <option value="3">Week 3: DSCR Quotes</option>
              <option value="4">Week 4: Follow-up</option>
            </select>

            <div class="form-check mb-2">
              <input class="form-check-input" type="checkbox" name="debug" id="debug_reports" value="true">
              <label class="form-check-label small text-muted" for="debug_reports">Debug Mode</label>
            </div>
          </div>

          <button type="submit" class="btn btn-success w-100 btn-lg" {% if workflow_status.running %}disabled{% endif %}>
            <i class="bi bi-play-fill"></i> Run Weekly Reports
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Tools Section -->
<div class="row g-4">
  <div class="col-12">
    <div class="glass-panel p-4">
      <h5 class="mb-4 d-flex align-items-center gap-2">
        <i class="bi bi-tools text-warning"></i> Tools & Individual Operations
      </h5>

      <div class="row g-3">
        <!-- Data Pipeline Tools -->
        <div class="col-md-4">
          <div class="glass-card p-3">
            <h6 class="text-white mb-3 pb-2 border-bottom border-secondary border-opacity-25">
              <i class="bi bi-database-fill-gear text-primary me-2"></i>Data Pipeline
            </h6>
            <div class="d-flex flex-column gap-2">
              <form method="POST" action="{{ url_for('workflow.scrape_pricing') }}">
                <button type="submit" class="btn btn-outline-light btn-sm w-100 text-start" {% if workflow_status.running %}disabled{% endif %}>
                  <i class="bi bi-cash-stack me-2"></i> Scrape Daily Pricing
                </button>
              </form>
              <form method="POST" action="{{ url_for('workflow.scrape_homes') }}">
                <button type="submit" class="btn btn-outline-light btn-sm w-100 text-start" {% if workflow_status.running %}disabled{% endif %}>
                  <i class="bi bi-download me-2"></i> Scrape HTML Files
                </button>
              </form>
              <form method="POST" action="{{ url_for('workflow.process_listings') }}">
                <button type="submit" class="btn btn-outline-light btn-sm w-100 text-start" {% if workflow_status.running %}disabled{% endif %}>
                  <i class="bi bi-file-code me-2"></i> Process Listings
                </button>
              </form>
            </div>
          </div>
        </div>

        <!-- Quote Generation Tools -->
        <div class="col-md-4">
          <div class="glass-card p-3">
            <h6 class="text-white mb-3 pb-2 border-bottom border-secondary border-opacity-25">
              <i class="bi bi-calculator-fill text-info me-2"></i>Quote Generation
            </h6>
            <div class="d-flex flex-column gap-2">
              <form method="POST" action="{{ url_for('workflow.generate_quotes') }}">
                <button type="submit" class="btn btn-outline-light btn-sm w-100 text-start" {% if workflow_status.running %}disabled{% endif %}>
                  <i class="bi bi-calculator me-2"></i> Generate QM Quotes
                </button>
              </form>
              <form method="POST" action="{{ url_for('workflow.dscr_pricing') }}">
                <button type="submit" class="btn btn-outline-light btn-sm w-100 text-start" {% if workflow_status.running %}disabled{% endif %}>
                  <i class="bi bi-building me-2"></i> Add DSCR Pricing
                </button>
              </form>
              <form method="POST" action="{{ url_for('workflow.generate_dscr_quotes') }}">
                <button type="submit" class="btn btn-outline-light btn-sm w-100 text-start" {% if workflow_status.running %}disabled{% endif %}>
                  <i class="bi bi-building-check me-2"></i> Generate DSCR Quotes
                </button>
              </form>
            </div>
          </div>
        </div>

        <!-- Email Tools -->
        <div class="col-md-4">
          <div class="glass-card p-3">
            <h6 class="text-white mb-3 pb-2 border-bottom border-secondary border-opacity-25">
              <i class="bi bi-envelope-fill text-success me-2"></i>Email Operations
            </h6>
            <div class="d-flex flex-column gap-2">
              <form method="POST" action="{{ url_for('workflow.send_emails') }}">
                <button type="submit" class="btn btn-outline-light btn-sm w-100 text-start" {% if workflow_status.running %}disabled{% endif %}>
                  <i class="bi bi-envelope me-2"></i> Send QM Emails
                </button>
              </form>
              <form method="POST" action="{{ url_for('workflow.send_dscr_emails') }}">
                <button type="submit" class="btn btn-outline-light btn-sm w-100 text-start" {% if workflow_status.running %}disabled{% endif %}>
                  <i class="bi bi-envelope-at me-2"></i> Send DSCR Emails
                </button>
              </form>
              <form method="POST" action="{{ url_for('workflow.send_affordability_emails') }}">
                <button type="submit" class="btn btn-outline-light btn-sm w-100 text-start" {% if workflow_status.running %}disabled{% endif %}>
                  <i class="bi bi-graph-up me-2"></i> Send Affordability Reports
                </button>
              </form>
              <form method="POST" action="{{ url_for('workflow.send_followup_emails') }}">
                <button type="submit" class="btn btn-outline-light btn-sm w-100 text-start" {% if workflow_status.running %}disabled{% endif %}>
                  <i class="bi bi-chat-left-text me-2"></i> Send Follow-up Emails
                </button>
              </form>
            </div>
          </div>
        </div>

        <!-- Maintenance Tools -->
        <div class="col-md-4">
          <div class="glass-card p-3">
            <h6 class="text-white mb-3 pb-2 border-bottom border-secondary border-opacity-25">
              <i class="bi bi-wrench-adjustable text-warning me-2"></i>Maintenance
            </h6>
            <div class="d-flex flex-column gap-2">
              <form method="POST" action="{{ url_for('workflow.archive') }}">
                <button type="submit" class="btn btn-outline-light btn-sm w-100 text-start" {% if workflow_status.running %}disabled{% endif %}>
                  <i class="bi bi-archive me-2"></i> Archive Listings
                </button>
              </form>
              <form method="POST" action="{{ url_for('workflow.cleanup') }}" onsubmit="return confirm('Delete archived records?');">
                <input type="hidden" name="confirm" value="true">
                <button type="submit" class="btn btn-outline-danger btn-sm w-100 text-start" {% if workflow_status.running %}disabled{% endif %}>
                  <i class="bi bi-trash me-2"></i> Cleanup Archives
                </button>
              </form>
            </div>
          </div>
        </div>

        <!-- User Management Tools -->
        <div class="col-md-4">
          <div class="glass-card p-3">
            <h6 class="text-white mb-3 pb-2 border-bottom border-secondary border-opacity-25">
              <i class="bi bi-people-fill text-secondary me-2"></i>User Management
            </h6>
            <div class="d-flex flex-column gap-2">
              <a href="{{ url_for('admin.unsubscribe_user') }}" class="btn btn-outline-light btn-sm w-100 text-start">
                <i class="bi bi-person-x me-2"></i> Unsubscribe User
              </a>
              <a href="{{ url_for('admin.user_activity_detail') }}" class="btn btn-outline-light btn-sm w-100 text-start">
                <i class="bi bi-activity me-2"></i> User Activity Search
              </a>
              <a href="{{ url_for('admin.suspicious_activity') }}" class="btn btn-outline-light btn-sm w-100 text-start">
                <i class="bi bi-shield-exclamation me-2"></i> Suspicious Activity
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
  // Auto-refresh status every 5 seconds if workflow is running
  {% if workflow_status.running %}
  setTimeout(function () {
    window.location.reload();
  }, 5000);
  {% endif %}
</script>
{% endblock %}